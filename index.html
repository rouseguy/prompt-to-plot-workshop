<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>GoodReads Scatter Plots</title>
<script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
<style>
body{font-family:"Segoe UI",Roboto,sans-serif;background:#fafafa;color:#111;margin:0}
svg{width:100%;height:350px;display:block}
.axis path,.axis line{stroke:#999;stroke-width:.5;shape-rendering:crispEdges}
.grid line{stroke:#ddd;stroke-width:.5}
circle{fill:steelblue;opacity:.2}
path.trend{fill:none;stroke:orange;stroke-width:2}
footer{padding:1em;text-align:center;font-size:.9em;color:#555}
</style>
</head>
<body>
<div id="plot1"></div>
<div id="plot2"></div>
<div id="plot3"></div>
<footer>Visualization by Data Team &middot; Source: <a href="https://goodreads.com">Goodreads</a></footer>
<script>
fetch('scatter_data.json').then(r=>r.json()).then(data=>{
  data.forEach(d=>{d.pages=+d.pages;d.blurb=+d.blurb;d.reviews=+d.reviews;d.rating=+d.rating;d.logRev=Math.log10(d.reviews||1)});
  const plots=[
    {id:'#plot1',x:d=>d.pages,label:'Pages'},
    {id:'#plot2',x:d=>d.blurb,label:'Blurb Length'},
    {id:'#plot3',x:d=>d.logRev,label:'log₁₀(Reviews)'}
  ];
  const margin={top:20,right:20,bottom:40,left:50};
  function loess(points,f=0.3){
    const n=points.length,r=Math.floor(f*n);
    const xs=points.map(p=>p[0]);
    const ys=points.map(p=>p[1]);
    const res=[];for(let i=0;i<n;i++){
      const x=xs[i];
      let lo=Math.max(0,i-r),hi=Math.min(n-1,i+r);
      const x0=x;let denom=0,b0=0,b1=0,a0=0,a1=0;
      let dmax=Math.max(Math.abs(x-xs[lo]),Math.abs(xs[hi]-x))||1;
      for(let j=lo;j<=hi;j++){
        const w=Math.pow(1-Math.pow(Math.abs(xs[j]-x)/dmax,3),3);
        denom+=w;
        b0+=w*xs[j];
        b1+=w*ys[j];
        a0+=w*xs[j]*xs[j];
        a1+=w*xs[j]*ys[j];
      }
      const meanx=b0/denom,meany=b1/denom;
      const beta=(a1-b0*meany)/(a0-b0*meanx||1e-12);
      const alpha=meany-beta*meanx;
      res.push([x,alpha+beta*x]);
    }
    return res.sort((a,b)=>a[0]-b[0]);
  }
  function render(){
    plots.forEach(p=>{
      const div=d3.select(p.id);div.selectAll('*').remove();
      const width=div.node().clientWidth-margin.left-margin.right;
      const height=350-margin.top-margin.bottom;
      const svg=div.append('svg');
      const x=d3.scaleLinear().domain(d3.extent(data,p.x)).nice().range([margin.left,width+margin.left]);
      const y=d3.scaleLinear().domain(d3.extent(data,d=>d.rating)).nice().range([height+margin.top,margin.top]);
      const g=svg.append('g');
      const gridX=d3.axisBottom(x).ticks(6).tickSize(-height).tickFormat('');
      const gridY=d3.axisLeft(y).ticks(6).tickSize(-width).tickFormat('');
      g.append('g').attr('class','grid').attr('transform',`translate(0,${height+margin.top})`).call(gridX);
      g.append('g').attr('class','grid').attr('transform',`translate(${margin.left},0)`).call(gridY);
      g.selectAll('circle').data(data).join('circle').attr('cx',d=>x(p.x(d))).attr('cy',d=>y(d.rating)).attr('r',3).append('title').text(d=>`${p.label}: ${p.x(d)}\nRating: ${d.rating}`);
      const line=d3.line().curve(d3.curveMonotoneX);
      const ldata=loess(data.map(d=>[p.x(d),d.rating]));
      g.append('path').attr('class','trend').attr('d',line(ldata));
      g.append('g').attr('class','axis').attr('transform',`translate(0,${height+margin.top})`).call(d3.axisBottom(x));
      g.append('g').attr('class','axis').attr('transform',`translate(${margin.left},0)`).call(d3.axisLeft(y));
      svg.append('text').attr('x',margin.left).attr('y',15).text(p.label+' vs Rating');
    });
  }
  render();
  window.addEventListener('resize',render);
});
</script>
</body>
</html>
